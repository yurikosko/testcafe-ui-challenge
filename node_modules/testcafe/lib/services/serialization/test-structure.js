"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.restore = exports.serialize = exports.flatten = exports.isFixture = exports.isTest = void 0;
const lodash_1 = require("lodash");
const protocol_1 = require("../compiler/protocol");
const unit_type_1 = __importDefault(require("../../api/structure/unit-type"));
const RECURSIVE_PROPERTIES = ['testFile', 'fixture', 'currentFixture', 'collectedTests'];
function isProperty(object, property) {
    return object.hasOwnProperty(property);
}
function isTest(value) {
    return value.unitType === unit_type_1.default.test;
}
exports.isTest = isTest;
function isFixture(value) {
    return value.unitType === unit_type_1.default.fixture;
}
exports.isFixture = isFixture;
function mapProperties(object, properties, mapper) {
    for (const property of properties) {
        if (!isProperty(object, property))
            continue;
        const value = object[property];
        if (Array.isArray(value))
            object[property] = value.map(item => mapper({ item, property, object }));
        else
            object[property] = mapper({ item: object[property], property, object });
    }
}
function replaceTestFunctions(unit) {
    mapProperties(unit, protocol_1.TEST_FUNCTION_PROPERTIES, ({ item }) => !!item);
}
function restoreTestFunctions(unit, mapper) {
    mapProperties(unit, protocol_1.TEST_FUNCTION_PROPERTIES, ({ item, object, property }) => item ? mapper(object.id, property) : item);
}
function flattenRecursiveProperties(unit) {
    mapProperties(unit, RECURSIVE_PROPERTIES, ({ item }) => item.id);
}
function restoreRecursiveProperties(unit, units) {
    mapProperties(unit, RECURSIVE_PROPERTIES, ({ item }) => units[item]);
}
function flatten(tests) {
    const testFiles = lodash_1.uniq(tests.map(test => test.testFile));
    const fixtures = lodash_1.uniq(tests.map(test => test.fixture));
    return lodash_1.keyBy([...tests, ...fixtures, ...testFiles], unit => unit.id);
}
exports.flatten = flatten;
function serialize(units) {
    const result = {};
    for (const unit of Object.values(units)) {
        // @ts-ignore
        const copy = Object.assign({}, unit);
        replaceTestFunctions(copy);
        flattenRecursiveProperties(copy);
        result[copy.id] = copy;
    }
    return result;
}
exports.serialize = serialize;
function restore(units, mapper) {
    const list = Object.values(units);
    const result = [];
    for (const unit of list) {
        restoreRecursiveProperties(unit, units);
        restoreTestFunctions(unit, mapper);
    }
    for (const unit of list) {
        if (isTest(unit))
            result.push(unit);
    }
    return result;
}
exports.restore = restore;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGVzdC1zdHJ1Y3R1cmUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvc2VydmljZXMvc2VyaWFsaXphdGlvbi90ZXN0LXN0cnVjdHVyZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7QUFBQSxtQ0FBcUM7QUFDckMsbURBQWdFO0FBS2hFLDhFQUFxRDtBQUdyRCxNQUFNLG9CQUFvQixHQUFHLENBQUMsVUFBVSxFQUFFLFNBQVMsRUFBRSxnQkFBZ0IsRUFBRSxnQkFBZ0IsQ0FBVSxDQUFDO0FBc0JsRyxTQUFTLFVBQVUsQ0FBb0IsTUFBUyxFQUFFLFFBQWdCO0lBQzlELE9BQU8sTUFBTSxDQUFDLGNBQWMsQ0FBQyxRQUFRLENBQUMsQ0FBQztBQUMzQyxDQUFDO0FBRUQsU0FBZ0IsTUFBTSxDQUFFLEtBQVc7SUFDL0IsT0FBTyxLQUFLLENBQUMsUUFBUSxLQUFLLG1CQUFRLENBQUMsSUFBSSxDQUFDO0FBQzVDLENBQUM7QUFGRCx3QkFFQztBQUVELFNBQWdCLFNBQVMsQ0FBRSxLQUFXO0lBQ2xDLE9BQU8sS0FBSyxDQUFDLFFBQVEsS0FBSyxtQkFBUSxDQUFDLE9BQU8sQ0FBQztBQUMvQyxDQUFDO0FBRkQsOEJBRUM7QUFFRCxTQUFTLGFBQWEsQ0FBNEQsTUFBUyxFQUFFLFVBQWEsRUFBRSxNQUE0QjtJQUNwSSxLQUFLLE1BQU0sUUFBUSxJQUFJLFVBQVUsRUFBRTtRQUMvQixJQUFJLENBQUMsVUFBVSxDQUFDLE1BQU0sRUFBRSxRQUFRLENBQUM7WUFDN0IsU0FBUztRQUViLE1BQU0sS0FBSyxHQUFHLE1BQU0sQ0FBQyxRQUFRLENBQUMsQ0FBQztRQUUvQixJQUFJLEtBQUssQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDO1lBQ3BCLE1BQU0sQ0FBQyxRQUFRLENBQUMsR0FBRyxLQUFLLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsTUFBTSxDQUFDLEVBQUUsSUFBSSxFQUFFLFFBQVEsRUFBRSxNQUFN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QUksTUFBTSxDQUFDLElBQUksQ0FBQztZQUNaLE1BQU0sQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7S0FDekI7SUFFRCxPQUFPLE1BQU0sQ0FBQztBQUNsQixDQUFDO0FBaEJELDBCQWdCQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IHVuaXEsIGtleUJ5IH0gZnJvbSAnbG9kYXNoJztcbmltcG9ydCB7IFRFU1RfRlVOQ1RJT05fUFJPUEVSVElFUyB9IGZyb20gJy4uL2NvbXBpbGVyL3Byb3RvY29sJztcblxuaW1wb3J0IFRlc3QgZnJvbSAnLi4vLi4vYXBpL3N0cnVjdHVyZS90ZXN0JztcbmltcG9ydCBGaXh0dXJlIGZyb20gJy4uLy4uL2FwaS9zdHJ1Y3R1cmUvZml4dHVyZSc7XG5pbXBvcnQgVGVzdEZpbGUgZnJvbSAnLi4vLi4vYXBpL3N0cnVjdHVyZS90ZXN0LWZpbGUnO1xuaW1wb3J0IFVuaXRUeXBlIGZyb20gJy4uLy4uL2FwaS9zdHJ1Y3R1cmUvdW5pdC10eXBlJztcblxuXG5jb25zdCBSRUNVUlNJVkVfUFJPUEVSVElFUyA9IFsndGVzdEZpbGUnLCAnZml4dHVyZScsICdjdXJyZW50Rml4dHVyZScsICdjb2xsZWN0ZWRUZXN0cyddIGFzIGNvbnN0O1xuXG5pbnRlcmZhY2UgRnVuY3Rpb25NYXBwZXIge1xuICAgIChpZDogc3RyaW5nLCBmdW5jdGlvbk5hbWU6IHR5cGVvZiBURVNUX0ZVTkNUSU9OX1BST1BFUlRJRVNbbnVtYmVyXSk6IEZ1bmN0aW9uO1xufVxuXG5pbnRlcmZhY2UgTWFwcGVyQXJndW1lbnRzPFQsIFA+IHtcbiAgICBvYmplY3Q6IFQ7XG4gICAgcHJvcGVydHk6IFA7XG4gICAgaXRlbTogYW55O1xufVxuXG5pbnRlcmZhY2UgTWFwcGVyPFQsIFA+IHtcbiAgICAoeyBpdGVtLCBwcm9wZXJ0eSwgb2JqZWN0IH06IE1hcHBlckFyZ3VtZW50czxULCBQPik6IGFueTtcbn1cblxuZXhwb3J0IHR5cGUgVW5pdCA9IFRlc3QgfCBGaXh0dXJlIHwgVGVzdEZpbGU7XG5cbmV4cG9ydCBpbnRlcmZhY2UgVW5pdHMge1xuICAgIFtpZDogc3RyaW5nXTogVW5pdDtcbn1cblxuZnVuY3Rpb24gaXNQcm9wZXJ0eTxUIGV4dGVuZHMgb2JqZWN0PiAob2JqZWN0OiBULCBwcm9wZXJ0eTogc3RyaW5nKTogcHJvcGVydHkgaXMgRXh0cmFjdDxrZXlvZiBULCBzdHJpbmc+IHtcbiAgICByZXR1cm4gb2JqZWN0Lmhhc093blByb3BlcnR5KHByb3BlcnR5KTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGlzVGVzdCAodmFsdWU6IFVuaXQpOiB2YWx1ZSBpcyBUZXN0IHtcbiAgICByZXR1cm4gdmFsdWUudW5pdFR5cGUgPT09IFVuaXRUeXBlLnRlc3Q7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBpc0ZpeHR1cmUgKHZhbHVlOiBVbml0KTogdmFsdWUgaXMgRml4dHVyZSB7XG4gICAgcmV0dXJuIHZhbHVlLnVuaXRUeXBlID09PSBVbml0VHlwZS5maXh0dXJlO1xufVxuXG5mdW5jdGlvbiBtYXBQcm9wZXJ0aWVzPFQgZXh0ZW5kcyBSZWFkb25seTxvYmplY3Q+LCBQIGV4dGVuZHMgUmVhZG9ubHk8c3RyaW5nW10+PiAob2JqZWN0OiBULCBwcm9wZXJ0aWVzOiBQLCBtYXBwZXI6IE1hcHBlcjxULCBQW251bWJlcl0+KTogdm9pZCB7XG4gICAgZm9yIChjb25zdCBwcm9wZXJ0eSBvZiBwcm9wZXJ0aWVzKSB7XG4gICAgICAgIGlmICghaXNQcm9wZXJ0eShvYmplY3QsIHByb3BlcnR5KSlcbiAgICAgICAgICAgIGNvbnRpbnVlO1xuXG4gICAgICAgIGNvbnN0IHZhbHVlID0gb2JqZWN0W3Byb3BlcnR5XTtcblxuICAgICAgICBpZiAoQXJyYXkuaXNBcnJheSh2YWx1ZSkpXG4gICAgICAgICAgICBvYmplY3RbcHJvcGVydHldID0gdmFsdWUubWFwKGl0ZW0gPT4gbWFwcGVyKHsgaXRlbSwgcHJvcGVydHksIG9iamVjdCB9KSkgYXMgYW55O1xuICAgICAgICBlbHNlXG4gICAgICAgICAgICBvYmplY3RbcHJvcGVydHldID0gbWFwcGVyKHsgaXRlbTogb2JqZWN0W3Byb3BlcnR5XSwgcHJvcGVydHksIG9iamVjdCB9KTtcbiAgICB9XG59XG5cbmZ1bmN0aW9uIHJlcGxhY2VUZXN0RnVuY3Rpb25zICh1bml0OiBVbml0KTogdm9pZCB7XG4gICAgbWFwUHJvcGVydGllcyh1bml0LCBURVNUX0ZVTkNUSU9OX1BST1BFUlRJRVMsICh7IGl0ZW0gfSkgPT4gISFpdGVtKTtcbn1cblxuZnVuY3Rpb24gcmVzdG9yZVRlc3RGdW5jdGlvbnMgKHVuaXQ6IFVuaXQsIG1hcHBlcjogRnVuY3Rpb25NYXBwZXIpOiB2b2lkIHtcbiAgICBtYXBQcm9wZXJ0aWVzKHVuaXQsIFRFU1RfRlVOQ1RJT05fUFJPUEVSVElFUywgKHsgaXRlbSwgb2JqZWN0LCBwcm9wZXJ0eSB9KSA9PiBpdGVtID8gbWFwcGVyKG9iamVjdC5pZCwgcHJvcGVydHkpIDogaXRlbSk7XG59XG5cbmZ1bmN0aW9uIGZsYXR0ZW5SZWN1cnNpdmVQcm9wZXJ0aWVzICh1bml0OiBVbml0KTogdm9pZCB7XG4gICAgbWFwUHJvcGVydGllcyh1bml0LCBSRUNVUlNJVkVfUFJPUEVSVElFUywgKHsgaXRlbSB9KSA9PiBpdGVtLmlkKTtcbn1cblxuZnVuY3Rpb24gcmVzdG9yZVJlY3Vyc2l2ZVByb3BlcnRpZXMgKHVuaXQ6IFVuaXQsIHVuaXRzOiBVbml0cyk6IHZvaWQge1xuICAgIG1hcFByb3BlcnRpZXModW5pdCwgUkVDVVJTSVZFX1BST1BFUlRJRVMsICh7IGl0ZW0gfSkgPT4gdW5pdHNbaXRlbV0pO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gZmxhdHRlbiAodGVzdHM6IFRlc3RbXSk6IFVuaXRzIHtcbiAgICBjb25zdCB0ZXN0RmlsZXMgPSB1bmlxKHRlc3RzLm1hcCh0ZXN0ID0+IHRlc3QudGVzdEZpbGUpKTtcbiAgICBjb25zdCBmaXh0dXJlcyAgPSB1bmlxKHRlc3RzLm1hcCh0ZXN0ID0+IHRlc3QuZml4dHVyZSkpO1xuXG4gICAgcmV0dXJuIGtleUJ5KFsuLi50ZXN0cywgLi4uZml4dHVyZXMsIC4uLnRlc3RGaWxlc10sIHVuaXQgPT4gdW5pdC5pZCk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBzZXJpYWxpemUgKHVuaXRzOiBVbml0cyk6IFVuaXRzIHtcbiAgICBjb25zdCByZXN1bHQ6IFVuaXRzID0ge307XG5cbiAgICBmb3IgKGNvbnN0IHVuaXQgb2YgT2JqZWN0LnZhbHVlcyh1bml0cykpIHtcbiAgICAgICAgLy8gQHRzLWlnbm9yZVxuICAgICAgICBjb25zdCBjb3B5OiBVbml0ID0geyAuLi51bml0IH07XG5cbiAgICAgICAgcmVwbGFjZVRlc3RGdW5jdGlvbnMoY29weSk7XG4gICAgICAgIGZsYXR0ZW5SZWN1cnNpdmVQcm9wZXJ0aWVzKGNvcHkpO1xuXG4gICAgICAgIHJlc3VsdFtjb3B5LmlkXSA9IGNvcHk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHJlc3VsdDtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHJlc3RvcmUgKHVuaXRzOiBVbml0cywgbWFwcGVyOiBGdW5jdGlvbk1hcHBlcik6IFRlc3RbXSB7XG4gICAgY29uc3QgbGlzdCA9IE9iamVjdC52YWx1ZXModW5pdHMpO1xuXG4gICAgY29uc3QgcmVzdWx0OiBUZXN0W10gPSBbXTtcblxuICAgIGZvciAoY29uc3QgdW5pdCBvZiBsaXN0KSB7XG4gICAgICAgIHJlc3RvcmVSZWN1cnNpdmVQcm9wZXJ0aWVzKHVuaXQsIHVuaXRzKTtcbiAgICAgICAgcmVzdG9yZVRlc3RGdW5jdGlvbnModW5pdCwgbWFwcGVyKTtcbiAgICB9XG5cbiAgICBmb3IgKGNvbnN0IHVuaXQgb2YgbGlzdCkge1xuICAgICAgICBpZiAoaXNUZXN0KHVuaXQpKVxuICAgICAgICAgICAgcmVzdWx0LnB1c2godW5pdCk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHJlc3VsdDtcbn1cbiJdfQ==